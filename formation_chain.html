<html>
<head>
<title>formation_chain</title>
<style type="text/css">
<!--
  :link { color: rgb(110, 0, 110); } 
  :visited { color: rgb(110, 0, 110); } 
  body { margin-left: 5px; font-family: arial, sans-serif; 
         background: white; font-size: 12pt } 
  h2 { background: rgb(166,172,255); 
       font-size: 15pt; 
       padding-left: 6px; padding-right: 6px; padding-top: 6px; 
       padding-bottom: 6px; } 
  p { margin-left: 10px; } 
  pre { margin-left: 13px; background: rgb(225,225,225); 
        font-family: monospace; padding-left: 3px; padding-right: 3px; 
        padding-top: 3px; padding-bottom: 3px; } 
-->
</style>
</head>
<body>

<p>This page was automatically generated by NetLogo 4.1.3.</p>

<p>The applet requires Java 5 or higher.
Java must be enabled in your browser settings.
Mac users must have Mac OS X 10.4 or higher.
Windows and Linux users may obtain the latest Java from
<a href="http://java.sun.com/getjava/download.html">Sun's Java site</a>.</p>

<p>
<applet code="org.nlogo.lite.Applet"
        archive="NetLogoLite.jar"
        width="955" height="720">
  <param name="DefaultModel"
         value="formation_chain.nlogo">
</applet>
</p>

<p>powered by
<a target="_blank" href="http://ccl.northwestern.edu/netlogo/">NetLogo</a></p>

<p>view/download model file:
<a href="formation_chain.nlogo">formation_chain.nlogo</a>
</p>
<h2>WHAT IS IT?</h2>
<p>This is an extension of &quot;formation_newton.nlogo,&quot; for the book entitled &quot;Physicomimetics: Physics-Based Swarm Intelligence.&quot;</p><br>
<h2>HOW IT WORKS</h2>
<p>Multiple particles use F = ma and an elliptical &quot;split Newtonian&quot; force law to self-organize into chain formations. </p><br>
<h2>WHAT IS NEW</h2>
<p>This is the second simulation for Chapter 4 of the book, which pushes the envelope of physicomimetics.  This simulation creates chain formations using a simple and elegant change to the standard physicomimetics model.</p>
<p>In the previous simulations we assume that the force laws are &quot;circularly symmetric,&quot; which means that the force is the same regardless of direction. If we want chain formations, it is possible to create them using force laws that are elliptical rather than circular. In this implementation the major axis of the ellipse is aligned with the heading of the particle (robot).</p>
<p>Once again, we deliberately break Newton's third law. This occurs because the force law is no longer circularly symmetric and particles do not necessarily experience equal and opposite forces.  Hence linear and angular momenta will not be conserved. Given that, what should we expect from our simulation? First, if angular momentum is violated, this should create chains that are curved. But that isn't an issue, because we don't want our chains to be straight lines - we want them to be able to bend according to the environment. A violation of linear momentum is more important, because the center of mass will move. However, this is not catastrophic. It suffices to have some nodes in the chain remain close to the initial cluster. In terms of practical use, we are assuming (as we have throughout this book) that robots are initially deployed from a central location. Since the applications of interest include surveillance of sewers, tunnels and caves, it is imperative that some robots remain near their original location, so that the eventual communication chain can be easily monitored.</p>
<p>You can place obstacles in the environment with your mouse, to create an obstacle course. The OBSTACLE_FORCE slider controls the size of the obstacles (i.e., the extent at which the repulsive obstacle force is felt).</p>
<p>A MAX DISTANCE monitor shows the distance between the two particles that are farthest from each other.  This gives an indication of how straight (or curved) the chain formation is.</p><br>
<h2>HOW TO USE IT</h2>
<p>Click SETUP AGENTS to initialize the particles, and click MOVE AGENTS to have them move.</p>
<p>The CLEAR button will erase the particle paths, which becomes handy when particles have their pens down (more on this below).</p>
<p>The NUMBER_OF_PARTICLES slider allows you to control the number of particles created at initialization. Changing this slider while the simulation is running will have no effect. You can change the number of particles while the simulation is running by using the ONE IS BORN and KILL ONE buttons. However, the ONE IS BORN and KILL ONE buttons do not change the number of initial particles when the simulation is restarted by clicking SETUP AGENTS.</p>
<p>The ONE IS BORN button creates a new particle.</p>
<p>The KILL ONE button randomly kills an existing particle.</p>
<p>Obstacles can be placed in the environment by placing the mouse where you want the obstacle to be, and then clicking the mouse. The obstacle is shown as a green disk. The OBSTACLE_FORCE slider changes the size of the obstacle. This affects all obstacles and the change is shown visually as the sizes of the disks change.</p>
<p>All other sliders will affect the simulation when it is running.</p><br>
<h2>THINGS TO NOTICE</h2>
<p>Particles are initialized in a random cluster in the middle of the graphics pane, and self-organize into a chain formation. First, the particles collapse into a small linear structure. The orientation of that structure depends on the initial positions of the particles. Then the small structure slowly expands into a chain. The behavior is quite emergent.</p>
<p>The POWER controls the value of &quot;p&quot; in the generalized law. The DESIRED_SEPARATION is the desired distance between neighboring particles. The gravitational constant is computed automatically, using the theory established in Chapter 3.</p>
<p>Again, FRICTION is enabled. This allows the system to stabilize.</p>
<p>Note that when creating chain formations, angular and linear momenta are not conserved. The reason for this is explained in Chapter 4 of the book.</p>
<p>The large yellow circle in the simulation shows the initial center of mass of the system. A small red dot shows the current center of mass. Because linear momentum is not conserved the red dot will usually move away from the large yellow circle.  However, it suffices to have some particles remain close to the large yellow circle, since that is where they are initially dispersed.</p>
<p>This model allows you to add and remove particles. Removing particles allows you to test how robust the system is to particle failure. Adding particles allows you to see how scalable the system is, and illustrates just how nicely new particles are incorporated into the formation. </p><br>
<h2>THINGS TO TRY</h2>
<p>Add particles and see what happens.  Usually they are incorporated easily into the chain.</p>
<p>Remove particles. What happens and why?</p>
<p>Add obstacles while the chain is expanding.</p>
<p>What happens when you increase the MINOR_AXIS at the beginning of a simulation run? This parameter adjusts the width of the elliptical force law.  You may need to try this a few times to get a feel for how the behavior changes.</p>
<p>What happens if you start with a large DESIRED_SEPARATION and then decrease the value?</p>
<p>What happens if you start with a small DESIRED_SEPARATION and then increase the value?</p><br>
<h2>EXTENDING THE MODEL</h2>
<p>Extend the simulation so that it copes with the removal of particles and a decreasing DESIRED_SEPARATION. Chapter 12 will provide some hints.</p>
<p>Note, in order to change any NetLogo simulation, you must have the source code (i.e., &quot;formation_chain.nlogo&quot;) downloaded to your computer, as well as NetLogo itself. You can not change the code when you are running the simulation with your browser.</p><br>
<h2>NETLOGO FEATURES</h2>
<p>This simulation allows the user to create new particles and kill existing ones.</p>
<p>Killing a particle is accomplished via a call to the NetLogo procedure &quot;die.&quot;</p>
<p>To create a particle, the &quot;hatch&quot; command is used - this clones an existing particle and moves it away from the original. Also, the new particle has the &quot;pen down,&quot; which means that you will see the path that the particle takes. If the graphics pane becomes too busy, click on the CLEAR button.</p>
<p>This simulation makes use of NetLogo mouse events to allow the user to place obstacles in the environment.</p><br>
<h2>RELATED MODELS</h2>
<p>This is an extension of &quot;formation_newton.nlogo&quot; to create chain formations.</p><br>
<h2>CREDITS AND REFERENCES</h2>
<p>To see the first papers that outlined the work presented in this simulation:</p>
<p>Hettiarachchi, S., Maxim, P., Spears, W. M., and Spears, D. F. (2008) Connectivity of collaborative robots in partially observable domains. In Proceedings of the International Conference on Control, Automation, and Systems.</p>
<p>Maxim, P., Spears, W. M., and Spears, D. F. (2009) Robotic chain formations. In Proceedings of the IFAC Workshop on Networked Robotics.</p><br>
<h2>HOW TO CITE</h2>
<p>If you mention this model in an academic publication, we ask that you include these citations for the model itself and for the NetLogo software:<br>- Spears, W. M. and Spears, D. F. (eds.) Physicomimetics: Physics-Based Swarm Intelligence, Springer-Verlag, (2011).<br>- Wilensky, U. (1999). NetLogo. <a href="http://ccl.northwestern.edu/netlogo/">http://ccl.northwestern.edu/netlogo/</a>. Center for Connected Learning and Computer-Based Modeling, Northwestern University, Evanston, IL.</p><br>
<h2>COPYRIGHT NOTICE</h2>
<p>Copyright 2011 William M. Spears. All rights reserved.</p>
<p>Permission to use, modify or redistribute this model is hereby granted, provided that both of the following requirements are followed:<br>a) this copyright notice is included, and<br>b) this model will not be redistributed for profit without permission from William M. Spears. Contact William M. Spears for appropriate licenses for redistribution for profit.</p>
<p><a href="http://www.swarmotics.com">http://www.swarmotics.com</a></p><br>
<h2>PROCEDURES</h2>
<pre><font color="#5a5a5a">; William M. Spears and Diana F. Spears September 2011</font><font color="#000000">
</font><font color="#5a5a5a">; Chain Formation Tutorial, with Obstacles</font><font color="#000000">
</font><font color="#5a5a5a">; For research and educational use only</font><font color="#000000">

</font><font color="#660096">breed</font><font color="#000000"> [particles particle]                              </font><font color="#5a5a5a">; Introduce the &quot;particle&quot; breed</font><font color="#000000">
</font><font color="#660096">breed</font><font color="#000000"> [obstacles obstacle]                              </font><font color="#5a5a5a">; Introduce the &quot;obstacle&quot; breed</font><font color="#000000">

</font><font color="#007f69">globals</font><font color="#000000"> [total_lmx total_lmy total_angular_mom G p FR D maxr obstacleF
         center_of_mass_x center_of_mass_y FMAX DeltaT a2 b2 heavy]

</font><font color="#007f69">turtles-own</font><font color="#000000"> [hood deltax deltay r F Fx Fy v vx vy dvx dvy mass theta c1 s1
             lmx lmy lever_arm_x lever_arm_y lever_arm_r angular_mom dradius]

</font><font color="#007f69">to</font><font color="#000000"> setup                                                </font><font color="#5a5a5a">; Clear everything</font><font color="#000000">
   </font><font color="#0000aa">clear-all</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> maxr </font><font color="#963700">0</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> heavy </font><font color="#963700">100000</font><font color="#000000">                                     </font><font color="#5a5a5a">; Used for obstacles</font><font color="#000000">
                                                        </font><font color="#5a5a5a">; Create and initialize particles   </font><font color="#000000">
   create-particles Number_of_Particles [setup-particles]
   update-info
                                                        </font><font color="#5a5a5a">; Computes center of mass and displays location</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> center_of_mass_x (</font><font color="#660096">sum</font><font color="#000000"> [</font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> mass] </font><font color="#660096">of</font><font color="#000000"> particles) </font><font color="#660096">/</font><font color="#000000"> (</font><font color="#660096">sum</font><font color="#000000"> [mass] </font><font color="#660096">of</font><font color="#000000"> particles)
   </font><font color="#0000aa">set</font><font color="#000000"> center_of_mass_y (</font><font color="#660096">sum</font><font color="#000000"> [</font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> mass] </font><font color="#660096">of</font><font color="#000000"> particles) </font><font color="#660096">/</font><font color="#000000"> (</font><font color="#660096">sum</font><font color="#000000"> [mass] </font><font color="#660096">of</font><font color="#000000"> particles)
   </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">patch</font><font color="#000000"> (</font><font color="#660096">round</font><font color="#000000"> center_of_mass_x) (</font><font color="#660096">round</font><font color="#000000"> center_of_mass_y)
      [</font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">patches</font><font color="#000000"> </font><font color="#660096">in-radius</font><font color="#000000"> </font><font color="#963700">6</font><font color="#000000"> [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">yellow</font><font color="#000000">]]     </font><font color="#5a5a5a">; Initial center of mass is displayed in yellow</font><font color="#000000">
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> run-and-monitor
   </font><font color="#0000aa">if</font><font color="#000000"> (</font><font color="#660096">count</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">) [</font><font color="#0000aa">user-message</font><font color="#000000"> </font><font color="#963700">&quot;Please click HALT and then SETUP AGENTS first&quot;</font><font color="#000000"> </font><font color="#0000aa">stop</font><font color="#000000">]
   update-info
   </font><font color="#0000aa">ask</font><font color="#000000"> particles [ap-particles]
   </font><font color="#0000aa">ask</font><font color="#000000"> obstacles [ap-obstacles]
   </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000">   [move]
   
   </font><font color="#5a5a5a">; Use mouse click to create obstacles. Must make sure that mouse is within black graphics pane.</font><font color="#000000">
   </font><font color="#0000aa">if</font><font color="#000000"> (</font><font color="#660096">mouse-down?</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> </font><font color="#660096">mouse-inside?</font><font color="#000000">) [
      </font><font color="#0000aa">ifelse</font><font color="#000000"> ((</font><font color="#660096">count</font><font color="#000000"> obstacles) </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">) 
          [create-obstacles </font><font color="#963700">1</font><font color="#000000"> [</font><font color="#0000aa">setxy</font><font color="#000000"> </font><font color="#660096">mouse-xcor</font><font color="#000000"> </font><font color="#660096">mouse-ycor</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> vx </font><font color="#963700">0</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;circle&quot;</font><font color="#000000">
                               </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> (</font><font color="#963700">2</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> obstacleF) </font><font color="#0000aa">set</font><font color="#000000"> mass heavy </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">green</font><font color="#000000">]]
          [</font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">one-of</font><font color="#000000"> obstacles [</font><font color="#0000aa">hatch</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> [</font><font color="#0000aa">setxy</font><font color="#000000"> </font><font color="#660096">mouse-xcor</font><font color="#000000"> </font><font color="#660096">mouse-ycor</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> vx </font><font color="#963700">0</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000">]]]
      </font><font color="#0000aa">wait</font><font color="#000000"> </font><font color="#963700">0.2</font><font color="#000000">                                          </font><font color="#5a5a5a">; Pause so don't get a bunch of obstacles at once</font><font color="#000000">
   ]

                                                        </font><font color="#5a5a5a">; Computes center of mass and displays location</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> center_of_mass_x (</font><font color="#660096">sum</font><font color="#000000"> [</font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> mass] </font><font color="#660096">of</font><font color="#000000"> particles) </font><font color="#660096">/</font><font color="#000000"> (</font><font color="#660096">sum</font><font color="#000000"> [mass] </font><font color="#660096">of</font><font color="#000000"> particles)
   </font><font color="#0000aa">set</font><font color="#000000"> center_of_mass_y (</font><font color="#660096">sum</font><font color="#000000"> [</font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> mass] </font><font color="#660096">of</font><font color="#000000"> particles) </font><font color="#660096">/</font><font color="#000000"> (</font><font color="#660096">sum</font><font color="#000000"> [mass] </font><font color="#660096">of</font><font color="#000000"> particles)
   </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">patch</font><font color="#000000"> (</font><font color="#660096">round</font><font color="#000000"> center_of_mass_x) (</font><font color="#660096">round</font><font color="#000000"> center_of_mass_y) [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">red</font><font color="#000000">]

   </font><font color="#0000aa">set</font><font color="#000000"> total_lmx </font><font color="#660096">sum</font><font color="#000000"> [lmx] </font><font color="#660096">of</font><font color="#000000"> particles                 </font><font color="#5a5a5a">; Total linear momentum, x-component</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> total_lmy </font><font color="#660096">sum</font><font color="#000000"> [lmy] </font><font color="#660096">of</font><font color="#000000"> particles                 </font><font color="#5a5a5a">; Total linear momentum, y-component</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> total_angular_mom </font><font color="#660096">sum</font><font color="#000000"> [angular_mom] </font><font color="#660096">of</font><font color="#000000"> particles </font><font color="#5a5a5a">; Total angular momentum of objects</font><font color="#000000">
   </font><font color="#0000aa">tick</font><font color="#000000">
   do-plots
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> setup-particles                                      </font><font color="#5a5a5a">; Set up the particles</font><font color="#000000">
   </font><font color="#0000aa">setxy</font><font color="#000000"> (</font><font color="#660096">random-normal</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000">) (</font><font color="#660096">random-normal</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000">)        </font><font color="#5a5a5a">; Start in a cluster</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> </font><font color="#660096">random</font><font color="#000000"> </font><font color="#963700">360</font><font color="#000000">                               </font><font color="#5a5a5a">; Everyone has a random heading</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> vx </font><font color="#963700">0</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> mass </font><font color="#963700">1</font><font color="#000000">                         </font><font color="#5a5a5a">; Start with no motion and mass = 1</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#963700">8</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">white</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> theta </font><font color="#963700">0</font><font color="#000000">
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> ap-particles                                         </font><font color="#5a5a5a">; Run artificial physics on the particles</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> Fx </font><font color="#963700">0</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> Fy </font><font color="#963700">0</font><font color="#000000">                                    </font><font color="#5a5a5a">; Initialize force components to zero</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> vx (</font><font color="#963700">1</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> FR) </font><font color="#660096">*</font><font color="#000000"> vx                                 </font><font color="#5a5a5a">; Slow down according to friction</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> vy (</font><font color="#963700">1</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> FR) </font><font color="#660096">*</font><font color="#000000"> vy 
   
   </font><font color="#0000aa">set</font><font color="#000000"> hood [</font><font color="#660096">who</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">other</font><font color="#000000"> particles                    </font><font color="#5a5a5a">; Get the IDs of all other particles</font><font color="#000000">
   </font><font color="#0000aa">foreach</font><font color="#000000"> hood [         
      </font><font color="#0000aa">set</font><font color="#000000"> deltax (([</font><font color="#660096">xcor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> particle ?) </font><font color="#660096">-</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000">) 
      </font><font color="#0000aa">set</font><font color="#000000"> deltay (([</font><font color="#660096">ycor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> particle ?) </font><font color="#660096">-</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000">) 
      </font><font color="#0000aa">set</font><font color="#000000"> r </font><font color="#660096">sqrt</font><font color="#000000"> (deltax </font><font color="#660096">*</font><font color="#000000"> deltax </font><font color="#660096">+</font><font color="#000000"> deltay </font><font color="#660096">*</font><font color="#000000"> deltay)
      </font><font color="#0000aa">if</font><font color="#000000"> (r </font><font color="#660096">&gt;</font><font color="#000000"> maxr) [</font><font color="#0000aa">set</font><font color="#000000"> maxr r]
       
      </font><font color="#0000aa">if</font><font color="#000000"> (r </font><font color="#660096">&lt;</font><font color="#000000"> D) [                                      </font><font color="#5a5a5a">; The generalized split Newtonian law</font><font color="#000000">
         </font><font color="#0000aa">set</font><font color="#000000"> F (G </font><font color="#660096">*</font><font color="#000000"> mass </font><font color="#660096">*</font><font color="#000000"> ([mass] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">turtle</font><font color="#000000"> ?) </font><font color="#660096">/</font><font color="#000000"> (r </font><font color="#660096">^</font><font color="#000000"> p)) 
         </font><font color="#0000aa">if</font><font color="#000000"> (F </font><font color="#660096">&gt;</font><font color="#000000"> FMAX) [</font><font color="#0000aa">set</font><font color="#000000"> F FMAX]                     </font><font color="#5a5a5a">; Bounds check on force magnitude</font><font color="#000000">
         </font><font color="#0000aa">if</font><font color="#000000"> ((deltax </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">) </font><font color="#660096">or</font><font color="#000000"> (deltay </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">)) 
            [</font><font color="#0000aa">set</font><font color="#000000"> theta (</font><font color="#660096">atan</font><font color="#000000"> deltay deltax)]            </font><font color="#5a5a5a">; The bearing to the neighbor</font><font color="#000000">
         </font><font color="#0000aa">set</font><font color="#000000"> c1 (</font><font color="#660096">sin</font><font color="#000000"> (</font><font color="#660096">heading</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> theta))
         </font><font color="#0000aa">set</font><font color="#000000"> s1 (</font><font color="#660096">cos</font><font color="#000000"> (</font><font color="#660096">heading</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> theta))                 </font><font color="#5a5a5a">; See Chapter 4 for details</font><font color="#000000">
         </font><font color="#0000aa">set</font><font color="#000000"> dradius (</font><font color="#660096">sqrt</font><font color="#000000"> (</font><font color="#963700">1.0</font><font color="#000000"> </font><font color="#660096">/</font><font color="#000000"> ((c1 </font><font color="#660096">*</font><font color="#000000"> c1 </font><font color="#660096">/</font><font color="#000000"> a2) </font><font color="#660096">+</font><font color="#000000"> (s1 </font><font color="#660096">*</font><font color="#000000"> s1 </font><font color="#660096">/</font><font color="#000000"> b2))))
         </font><font color="#0000aa">ifelse</font><font color="#000000"> (r </font><font color="#660096">&gt;</font><font color="#000000"> dradius)                           </font><font color="#5a5a5a">; Creates elliptical force law</font><font color="#000000">
            [</font><font color="#0000aa">set</font><font color="#000000"> Fx (Fx </font><font color="#660096">+</font><font color="#000000"> F </font><font color="#660096">*</font><font color="#000000"> (deltax </font><font color="#660096">/</font><font color="#000000"> r))             </font><font color="#5a5a5a">; Attractive force, x-component</font><font color="#000000">
             </font><font color="#0000aa">set</font><font color="#000000"> Fy (Fy </font><font color="#660096">+</font><font color="#000000"> F </font><font color="#660096">*</font><font color="#000000"> (deltay </font><font color="#660096">/</font><font color="#000000"> r))]            </font><font color="#5a5a5a">; Attractive force, y-component</font><font color="#000000">
            [</font><font color="#0000aa">set</font><font color="#000000"> Fx (Fx </font><font color="#660096">-</font><font color="#000000"> F </font><font color="#660096">*</font><font color="#000000"> (deltax </font><font color="#660096">/</font><font color="#000000"> r))             </font><font color="#5a5a5a">; Repulsive force, x-component</font><font color="#000000">
             </font><font color="#0000aa">set</font><font color="#000000"> Fy (Fy </font><font color="#660096">-</font><font color="#000000"> F </font><font color="#660096">*</font><font color="#000000"> (deltay </font><font color="#660096">/</font><font color="#000000"> r))]            </font><font color="#5a5a5a">; Repulsive force, y-component</font><font color="#000000">
      ]
   ]
   
   </font><font color="#5a5a5a">; Now include obstacles</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> hood [</font><font color="#660096">who</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> obstacles                          </font><font color="#5a5a5a">; Get the IDs of obstacles</font><font color="#000000">
   </font><font color="#0000aa">foreach</font><font color="#000000"> hood [         
      </font><font color="#0000aa">set</font><font color="#000000"> deltax (([</font><font color="#660096">xcor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> obstacle ?) </font><font color="#660096">-</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000">) 
      </font><font color="#0000aa">set</font><font color="#000000"> deltay (([</font><font color="#660096">ycor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> obstacle ?) </font><font color="#660096">-</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000">) 
      </font><font color="#0000aa">set</font><font color="#000000"> r </font><font color="#660096">sqrt</font><font color="#000000"> (deltax </font><font color="#660096">*</font><font color="#000000"> deltax </font><font color="#660096">+</font><font color="#000000"> deltay </font><font color="#660096">*</font><font color="#000000"> deltay)
      </font><font color="#0000aa">if</font><font color="#000000"> (r </font><font color="#660096">&lt;=</font><font color="#000000"> obstacleF) [
         </font><font color="#0000aa">set</font><font color="#000000"> F (obstacleF </font><font color="#660096">-</font><font color="#000000"> r)                          </font><font color="#5a5a5a">; Simple linear force law</font><font color="#000000">
         </font><font color="#0000aa">set</font><font color="#000000"> Fx (Fx </font><font color="#660096">-</font><font color="#000000"> (F </font><font color="#660096">*</font><font color="#000000"> (deltax </font><font color="#660096">/</font><font color="#000000"> r)))               </font><font color="#5a5a5a">; Repulsive force, x-component</font><font color="#000000">
         </font><font color="#0000aa">set</font><font color="#000000"> Fy (Fy </font><font color="#660096">-</font><font color="#000000"> (F </font><font color="#660096">*</font><font color="#000000"> (deltay </font><font color="#660096">/</font><font color="#000000"> r)))               </font><font color="#5a5a5a">; Repulsive force, y-component</font><font color="#000000">
      ]
   ]
   
   </font><font color="#0000aa">set</font><font color="#000000"> dvx DeltaT </font><font color="#660096">*</font><font color="#000000"> (Fx </font><font color="#660096">/</font><font color="#000000"> mass)
   </font><font color="#0000aa">set</font><font color="#000000"> dvy DeltaT </font><font color="#660096">*</font><font color="#000000"> (Fy </font><font color="#660096">/</font><font color="#000000"> mass)
   </font><font color="#0000aa">set</font><font color="#000000"> vx  (vx </font><font color="#660096">+</font><font color="#000000"> dvx)                                   </font><font color="#5a5a5a">; The x-component of velocity</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> vy  (vy </font><font color="#660096">+</font><font color="#000000"> dvy)                                   </font><font color="#5a5a5a">; The y-component of velocity</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> v </font><font color="#660096">sqrt</font><font color="#000000"> (vx </font><font color="#660096">*</font><font color="#000000"> vx </font><font color="#660096">+</font><font color="#000000"> vy </font><font color="#660096">*</font><font color="#000000"> vy)

   </font><font color="#0000aa">set</font><font color="#000000"> deltax DeltaT </font><font color="#660096">*</font><font color="#000000"> vx
   </font><font color="#0000aa">set</font><font color="#000000"> deltay DeltaT </font><font color="#660096">*</font><font color="#000000"> vy 
   </font><font color="#0000aa">if</font><font color="#000000"> ((deltax </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">) </font><font color="#660096">or</font><font color="#000000"> (deltay </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">)) 
      [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> (</font><font color="#660096">atan</font><font color="#000000"> deltax deltay)] 
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> ap-obstacles                                         </font><font color="#5a5a5a">; Run artificial physics on the obstacles</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> Fx </font><font color="#963700">0</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> Fy </font><font color="#963700">0</font><font color="#000000">                                    </font><font color="#5a5a5a">; Initialize force components to zero</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> vx (</font><font color="#963700">1</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> FR) </font><font color="#660096">*</font><font color="#000000"> vx                                 </font><font color="#5a5a5a">; Slow down according to friction</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> vy (</font><font color="#963700">1</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> FR) </font><font color="#660096">*</font><font color="#000000"> vy 
   
   </font><font color="#0000aa">set</font><font color="#000000"> hood [</font><font color="#660096">who</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> particles                          </font><font color="#5a5a5a">; Get the IDs of all particles</font><font color="#000000">
   </font><font color="#0000aa">foreach</font><font color="#000000"> hood [         
      </font><font color="#0000aa">set</font><font color="#000000"> deltax (([</font><font color="#660096">xcor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> particle ?) </font><font color="#660096">-</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000">) 
      </font><font color="#0000aa">set</font><font color="#000000"> deltay (([</font><font color="#660096">ycor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> particle ?) </font><font color="#660096">-</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000">) 
      </font><font color="#0000aa">set</font><font color="#000000"> r </font><font color="#660096">sqrt</font><font color="#000000"> (deltax </font><font color="#660096">*</font><font color="#000000"> deltax </font><font color="#660096">+</font><font color="#000000"> deltay </font><font color="#660096">*</font><font color="#000000"> deltay)
      </font><font color="#0000aa">if</font><font color="#000000"> (r </font><font color="#660096">&lt;=</font><font color="#000000"> obstacleF) [
         </font><font color="#0000aa">set</font><font color="#000000"> F (obstacleF </font><font color="#660096">-</font><font color="#000000"> r)                          </font><font color="#5a5a5a">; Simple linear force law</font><font color="#000000">
         </font><font color="#0000aa">set</font><font color="#000000"> Fx (Fx </font><font color="#660096">-</font><font color="#000000"> F </font><font color="#660096">*</font><font color="#000000"> (deltax </font><font color="#660096">/</font><font color="#000000"> r))                 </font><font color="#5a5a5a">; Repulsive force, x-component</font><font color="#000000">
         </font><font color="#0000aa">set</font><font color="#000000"> Fy (Fy </font><font color="#660096">-</font><font color="#000000"> F </font><font color="#660096">*</font><font color="#000000"> (deltay </font><font color="#660096">/</font><font color="#000000"> r))                 </font><font color="#5a5a5a">; Repulsive force, y-component</font><font color="#000000">
      ]
   ]
      
   </font><font color="#0000aa">set</font><font color="#000000"> dvx DeltaT </font><font color="#660096">*</font><font color="#000000"> (Fx </font><font color="#660096">/</font><font color="#000000"> mass)
   </font><font color="#0000aa">set</font><font color="#000000"> dvy DeltaT </font><font color="#660096">*</font><font color="#000000"> (Fy </font><font color="#660096">/</font><font color="#000000"> mass)
   </font><font color="#0000aa">set</font><font color="#000000"> vx  (vx </font><font color="#660096">+</font><font color="#000000"> dvx)                                   </font><font color="#5a5a5a">; The x-component of velocity</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> vy  (vy </font><font color="#660096">+</font><font color="#000000"> dvy)                                   </font><font color="#5a5a5a">; The y-component of velocity</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> v </font><font color="#660096">sqrt</font><font color="#000000"> (vx </font><font color="#660096">*</font><font color="#000000"> vx </font><font color="#660096">+</font><font color="#000000"> vy </font><font color="#660096">*</font><font color="#000000"> vy)

   </font><font color="#0000aa">set</font><font color="#000000"> deltax DeltaT </font><font color="#660096">*</font><font color="#000000"> vx
   </font><font color="#0000aa">set</font><font color="#000000"> deltay DeltaT </font><font color="#660096">*</font><font color="#000000"> vy 
   </font><font color="#0000aa">if</font><font color="#000000"> ((deltax </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">) </font><font color="#660096">or</font><font color="#000000"> (deltay </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">)) 
      [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> (</font><font color="#660096">atan</font><font color="#000000"> deltax deltay)] 
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> move
   </font><font color="#0000aa">fd</font><font color="#000000"> </font><font color="#660096">sqrt</font><font color="#000000"> (deltax </font><font color="#660096">*</font><font color="#000000"> deltax </font><font color="#660096">+</font><font color="#000000"> deltay </font><font color="#660096">*</font><font color="#000000"> deltay)          </font><font color="#5a5a5a">; Move the turtle</font><font color="#000000">

   </font><font color="#0000aa">set</font><font color="#000000"> lmx (mass </font><font color="#660096">*</font><font color="#000000"> vx)                                  </font><font color="#5a5a5a">; Linear momentum of the turtle</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> lmy (mass </font><font color="#660096">*</font><font color="#000000"> vy)
   
   </font><font color="#0000aa">set</font><font color="#000000"> lever_arm_x (</font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> center_of_mass_x)
   </font><font color="#0000aa">set</font><font color="#000000"> lever_arm_y (</font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> center_of_mass_y)
   </font><font color="#0000aa">set</font><font color="#000000"> lever_arm_r </font><font color="#660096">sqrt</font><font color="#000000"> (lever_arm_x </font><font color="#660096">*</font><font color="#000000"> lever_arm_x </font><font color="#660096">+</font><font color="#000000"> lever_arm_y </font><font color="#660096">*</font><font color="#000000"> lever_arm_y)
   </font><font color="#0000aa">if</font><font color="#000000"> (((vx </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">) </font><font color="#660096">or</font><font color="#000000"> (vy </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">)) </font><font color="#660096">and</font><font color="#000000"> ((lever_arm_x </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">) </font><font color="#660096">or</font><font color="#000000"> (lever_arm_y </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">)))
      [</font><font color="#0000aa">set</font><font color="#000000"> theta (</font><font color="#660096">atan</font><font color="#000000"> (mass </font><font color="#660096">*</font><font color="#000000"> vy) (mass </font><font color="#660096">*</font><font color="#000000"> vx)) </font><font color="#660096">-</font><font color="#000000"> (</font><font color="#660096">atan</font><font color="#000000"> lever_arm_y lever_arm_x)]
   </font><font color="#0000aa">set</font><font color="#000000"> angular_mom (lever_arm_r </font><font color="#660096">*</font><font color="#000000"> mass </font><font color="#660096">*</font><font color="#000000"> v </font><font color="#660096">*</font><font color="#000000"> (</font><font color="#660096">sin</font><font color="#000000"> theta)) </font><font color="#5a5a5a">; Angular momentum of the turtle</font><font color="#000000">
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> update-info                                          </font><font color="#5a5a5a">; Update information from the sliders </font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> a2 (Major_Axis </font><font color="#660096">^</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000">) </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> b2 (Minor_Axis </font><font color="#660096">^</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000">) </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000">
   </font><font color="#0000aa">set</font><font color="#000000"> p Power
   </font><font color="#0000aa">set</font><font color="#000000"> FMAX Force_Maximum
   </font><font color="#0000aa">set</font><font color="#000000"> FR Friction
   </font><font color="#0000aa">set</font><font color="#000000"> DeltaT Time_Step
   </font><font color="#0000aa">set</font><font color="#000000"> D Desired_Separation
   </font><font color="#0000aa">set</font><font color="#000000"> obstacleF Obstacle_Force
   </font><font color="#0000aa">set</font><font color="#000000"> G (</font><font color="#963700">0.3</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> FMAX </font><font color="#660096">*</font><font color="#000000"> (D </font><font color="#660096">^</font><font color="#000000"> p))                         </font><font color="#5a5a5a">; Compute best G from theory!</font><font color="#000000">
   </font><font color="#0000aa">ask</font><font color="#000000"> obstacles [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> (</font><font color="#963700">2</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> obstacleF)]             </font><font color="#5a5a5a">; Update obstacle size if necessary</font><font color="#000000">
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> do-plots
   </font><font color="#0000aa">set-current-plot</font><font color="#000000"> </font><font color="#963700">&quot;Linear and Angular Momenta&quot;</font><font color="#000000">        </font><font color="#5a5a5a">; Select the Momenta plot</font><font color="#000000">
   </font><font color="#0000aa">set-current-plot-pen</font><font color="#000000"> </font><font color="#963700">&quot;Lmx&quot;</font><font color="#000000">                           </font><font color="#5a5a5a">; Select the Lmx pen</font><font color="#000000">
   </font><font color="#0000aa">plot</font><font color="#000000"> total_lmx                                       </font><font color="#5a5a5a">; Plot the linear momentum, x-component</font><font color="#000000">
   </font><font color="#0000aa">set-current-plot-pen</font><font color="#000000"> </font><font color="#963700">&quot;Lmy&quot;</font><font color="#000000">
   </font><font color="#0000aa">plot</font><font color="#000000"> total_lmy                                       </font><font color="#5a5a5a">; Plot the linear momentum, y-component</font><font color="#000000">
   </font><font color="#0000aa">set-current-plot-pen</font><font color="#000000"> </font><font color="#963700">&quot;Angular&quot;</font><font color="#000000">
   </font><font color="#0000aa">plot</font><font color="#000000"> total_angular_mom                               </font><font color="#5a5a5a">; Plot the angular momentum</font><font color="#000000">
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#5a5a5a">; Kill a particle</font><font color="#000000">
</font><font color="#007f69">to</font><font color="#000000"> one-dies
   </font><font color="#0000aa">if</font><font color="#000000"> (</font><font color="#660096">count</font><font color="#000000"> (particles </font><font color="#660096">with</font><font color="#000000"> [mass </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">]) </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">) [         </font><font color="#5a5a5a">; Don't kill last particle</font><font color="#000000">
      </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">one-of</font><font color="#000000"> particles </font><font color="#660096">with</font><font color="#000000"> [mass </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">] [</font><font color="#0000aa">die</font><font color="#000000">]        </font><font color="#5a5a5a">; Ask one particle to die</font><font color="#000000">
      </font><font color="#0000aa">clear-drawing</font><font color="#000000">                                     </font><font color="#5a5a5a">; A little cleanup is required</font><font color="#000000">
   ]
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#5a5a5a">; Create a new particle</font><font color="#000000">
</font><font color="#007f69">to</font><font color="#000000"> one-is-born
   </font><font color="#0000aa">if</font><font color="#000000"> (</font><font color="#660096">count</font><font color="#000000"> (particles </font><font color="#660096">with</font><font color="#000000"> [mass </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">]) </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">) [ 
      </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">one-of</font><font color="#000000"> particles </font><font color="#660096">with</font><font color="#000000"> [mass </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">]              </font><font color="#5a5a5a">; Clone an existing particle</font><font color="#000000">
         [</font><font color="#0000aa">hatch</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> [</font><font color="#0000aa">set</font><font color="#000000"> deltax </font><font color="#963700">0</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> deltay </font><font color="#963700">0</font><font color="#000000"> </font><font color="#0000aa">pd</font><font color="#000000">
                   </font><font color="#0000aa">setxy</font><font color="#000000"> (</font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> (</font><font color="#660096">random-normal</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">0.1</font><font color="#000000">))
                         (</font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> (</font><font color="#660096">random-normal</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">0.1</font><font color="#000000">))]]
   ] 
</font><font color="#007f69">end</font><font color="#000000">

</font>
</pre>

</body>
</html>
